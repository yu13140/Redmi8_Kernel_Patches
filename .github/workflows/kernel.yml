name: Extract Kernel from LineageOS 21

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      PAT: ${{ secrets.ACCESS_TOKEN }}    
    timeout-minutes: 360

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Free Disk Space (Ubuntu)
        if: env.LXC_ENABLE == 'true'
        uses: jlumbroso/free-disk-space@main
        with:
          # this might remove tools that are actually needed,
          # if set to "true" but frees about 6 GB
          tool-cache: true

          # all of these default to true, but feel free to set to
          # "false" if necessary for your workflow
          android: false
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

    - name: Maximize build space
        if: env.LXC_ENABLE != 'true'
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 51200
          temp-reserve-mb: 8192
          swap-size-mb: 16384
          remove-dotnet: "true"
          remove-android: "false"
          remove-haskell: "true"
          remove-codeql: "true"

    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y git curl python3 python3-pip

    - name: Install Repo Tool
      run: |
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Git Config
      run: |
        git config --global user.email "whmyc801@gmail.com"
        git config --global user.name "yu13140"

    - name: Initialize Repository
      run: |
        mkdir lineage
        cd lineage
        repo init -u https://github.com/LineageOS/android.git -b lineage-21.0
        repo sync -j64

    - name: Sync Source Code
      run: |
        . build/envsetup.sh
        breakfast "Mi439"

    - name: Extract Kernel Files
      run: |
        mkdir kernel_files
        ls lineage/kernel/xiaomi/
        cp -r lineage/kernel/xiaomi/sdm439/* kernel_files/
        # 验证内核文件存在
        if [ ! -d "kernel_files" ]; then
          echo "❌ Kernel files not found!"
          exit 1
        fi

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: olive-kernel
        path: kernel_files/

    - name: Commit to Repository
      run: |
        cd ~/kernel_files          
        git remote set-url origin "https://${PAT}@github.com/yu13140/LineageOS_Kernel_Redmi8.git"        
        git add .
        git commit -m "Update kernel files $(date +'%Y-%m-%d')" || echo "No changes to commit"
        git push -u origin main